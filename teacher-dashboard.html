<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ููุญุฉ ุชุญูู ุงููุนูู - ููุตุฉ ุงูุชุนููู ุงูุฅููุชุฑููู</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- ุดุฑูุท ุงูุชููู -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <a href="index.html" class="nav-link"><h2>๐ ููุตุฉ ุงูุชุนููู</h2></a>
            </div>
            <div class="nav-links">
                <a href="index.html" class="nav-link">ุงูุฑุฆูุณูุฉ</a>
                <a href="teachers.html" class="nav-link">ุงููุนูููู</a>
                <a href="lessons.html" class="nav-link">ุงูุฏุฑูุณ</a>
            </div>
            <div class="nav-user">
                <div class="user-dropdown">
                    <button class="user-name-btn" id="userName" onclick="toggleUserMenu()"></button>
                    <div class="user-menu" id="userMenu">
                        <a href="teacher-dashboard.html" class="user-menu-item nav-link active">ููุญุฉ ุงูุชุญูู</a>
                        <button onclick="openSettings()" class="user-menu-item">โ๏ธ ุงูุฅุนุฏุงุฏุงุช</button>
                        <button onclick="logout()" class="user-menu-item logout-btn">๐ช ุชุณุฌูู ุงูุฎุฑูุฌ</button>
                        <div class="user-email" id="userEmail">example@gmail.com</div>
                    </div>
                </div>
            </div>
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()">โฐ</button>
        </div>
    </nav>

    <!-- ุงููุญุชูู ุงูุฑุฆูุณู -->
    <main style="padding: 2rem 0; min-height: 80vh;">
        <div class="container">
            <!-- ุฑุฃุณ ุงูุตูุญุฉ -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <h1 style="font-size: 2.5rem; font-weight: 700; color: #1F2937; margin-bottom: 0.5rem;">ููุญุฉ ุชุญูู ุงููุนูู</h1>
                    <p style="color: #6B7280;" id="welcomeMessage">ูุฑุญุจุงู ุจู</p>
                </div>
                <button onclick="toggleAddForm()" class="btn btn-secondary btn-large" id="addLessonBtn">
                    โ ุฅุถุงูุฉ ุฏุฑุณ ุฌุฏูุฏ
                </button>
            </div>

            <!-- ุจุทุงูุงุช ุงูุฅุญุตุงุฆูุงุช -->
            <div class="stats-grid" style="margin-bottom: 3rem;">
                <div class="stat-card">
                    <div class="stat-icon">๐</div>
                    <div class="stat-number" id="totalLessons">0</div>
                    <div class="stat-label">ุฅุฌูุงูู ุงูุฏุฑูุณ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">๐๏ธ</div>
                    <div class="stat-number" id="totalViews">0</div>
                    <div class="stat-label">ุฅุฌูุงูู ุงููุดุงูุฏุงุช</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">๐ฅ</div>
                    <div class="stat-number">247</div>
                    <div class="stat-label">ุฅุฌูุงูู ุงูุทูุงุจ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">โญ</div>
                    <div class="stat-number">4.9</div>
                    <div class="stat-label">ุงูุชูููู ุงูุนุงู</div>
                </div>
            </div>

            <!-- ูููุฐุฌ ุฅุถุงูุฉ ุฏุฑุณ ุฌุฏูุฏ -->
            <div id="addLessonForm" class="hidden teacher-dashboard-add-form" style="padding: 2rem; border-radius: 16px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); margin-bottom: 3rem;">
                <h2 style="font-size: 1.75rem; font-weight: 600; margin-bottom: 1.5rem; color: #1F2937;">ุฅุถุงูุฉ ุฏุฑุณ ุฌุฏูุฏ</h2>
                
                <form id="lessonForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="title" class="form-label">ุนููุงู ุงูุฏุฑุณ *</label>
                            <input type="text" id="title" name="title" class="form-input" placeholder="ุฃุฏุฎู ุนููุงู ุงูุฏุฑุณ" required>
                        </div>
                        <div class="form-group">
                            <label for="subject" class="form-label">ุงููุงุฏุฉ *</label>
                            <select id="subject" name="subject" class="form-select" required>
                                <option value="">ุงุฎุชุฑ ุงููุงุฏุฉ</option>
                                <option value="ุงูุฑูุงุถูุงุช">ุงูุฑูุงุถูุงุช</option>
                                <option value="ุงูููุฒูุงุก">ุงูููุฒูุงุก</option>
                                <option value="ุงูููููุงุก">ุงูููููุงุก</option>
                                <option value="ุงููุบุฉ ุงูุนุฑุจูุฉ">ุงููุบุฉ ุงูุนุฑุจูุฉ</option>
                                <option value="ุงููุบุฉ ุงูุฅูุฌููุฒูุฉ">ุงููุบุฉ ุงูุฅูุฌููุฒูุฉ</option>
                                <option value="ุงูุชุงุฑูุฎ">ุงูุชุงุฑูุฎ</option>
                                <option value="ุงูุฌุบุฑุงููุง">ุงูุฌุบุฑุงููุง</option>
                                <option value="ุงูุจุฑูุฌุฉ">ุงูุจุฑูุฌุฉ</option>
                                <option value="ุฃุฎุฑู">ุฃุฎุฑู</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="description" class="form-label">ูุตู ุงูุฏุฑุณ *</label>
                        <textarea id="description" name="description" class="form-textarea" placeholder="ุงูุชุจ ูุตูุงู ุชูุตูููุงู ููุฏุฑุณ..." rows="4" required></textarea>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="youtubeUrl" class="form-label">ุฑุงุจุท ููุฏูู YouTube</label>
                            <input type="url" id="youtubeUrl" name="youtubeUrl" class="form-input" placeholder="https://www.youtube.com/watch?v=...">
                        </div>
                        <div class="form-group">
                            <label for="pdfUrl" class="form-label">ุฑุงุจุท ููู PDF</label>
                            <input type="url" id="pdfUrl" name="pdfUrl" class="form-input" placeholder="https://drive.google.com/...">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="duration" class="form-label">ูุฏุฉ ุงูุฏุฑุณ (ุจุงูุฏูุงุฆู)</label>
                        <input type="number" id="duration" name="duration" class="form-input" placeholder="45" min="1" max="300">
                    </div>

                    <div style="display: flex; gap: 1rem;">
                        <button type="submit" class="btn btn-primary">๐พ ุญูุธ ุงูุฏุฑุณ</button>
                        <button type="button" onclick="toggleAddForm()" class="btn btn-outline">โ ุฅูุบุงุก</button>
                    </div>
                </form>
            </div>

            <!-- ูุงุฆูุฉ ุฏุฑูุณู -->
            <div class="teacher-dashboard-lessons-section" style="padding: 2rem; border-radius: 16px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);">
                <h2 style="font-size: 1.75rem; font-weight: 600; margin-bottom: 1.5rem; color: #1F2937;">ุฏุฑูุณู</h2>
                
                <div id="myLessonsGrid">
                    <div class="loading">ุฌุงุฑู ุงูุชุญููู...</div>
                </div>
            </div>
        </div>
    </main>

    <script src="js/main.js"></script>
    <script>
        let showingAddForm = false;

        document.addEventListener('DOMContentLoaded', async function() {
            // ุงูุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ูุนูู
            await checkTeacherAccess();
            await loadMyLessons();
        });

        async function checkTeacherAccess() {
            try {
                const response = await fetch('/api/me');
                if (!response.ok) {
                    window.location.href = 'login.html';
                    return;
                }
                
                const user = await response.json();
                if (user.userType !== 'teacher') {
                    alert('ูุฐู ุงูุตูุญุฉ ูุฎุตุตุฉ ูููุนูููู ููุท');
                    window.location.href = 'index.html';
                    return;
                }
                
                // ุชุญุฏูุซ ุงุณู ุงููุณุชุฎุฏู
                document.getElementById('userName').textContent = `${user.firstName} ${user.lastName}`;
                document.getElementById('welcomeMessage').textContent = `ูุฑุญุจุงู ุจูุ ${user.firstName} ${user.lastName}`;
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุงูุชุญูู ูู ุงูุตูุงุญูุงุช:', error);
                window.location.href = 'login.html';
            }
        }

        async function loadMyLessons() {
            try {
                const response = await fetch('/api/my-lessons');
                if (!response.ok) {
                    throw new Error('ูุดู ูู ุชุญููู ุงูุฏุฑูุณ');
                }
                
                const lessons = await response.json();
                updateStats(lessons);
                displayMyLessons(lessons);
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุชุญููู ุงูุฏุฑูุณ:', error);
                document.getElementById('myLessonsGrid').innerHTML = `
                    <div class="error">
                        <h3>ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช</h3>
                        <p>ุชุนุฐุฑ ุชุญููู ุฏุฑูุณู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.</p>
                    </div>
                `;
            }
        }

        function updateStats(lessons) {
            const totalLessons = lessons.length;
            const totalViews = lessons.reduce((sum, lesson) => sum + (lesson.views || 0), 0);
            
            document.getElementById('totalLessons').textContent = totalLessons;
            document.getElementById('totalViews').textContent = formatArabicNumber(totalViews);
        }

        function displayMyLessons(lessons) {
            const myLessonsGrid = document.getElementById('myLessonsGrid');
            
            if (lessons.length === 0) {
                myLessonsGrid.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">๐</div>
                        <h3 style="font-size: 1.5rem; margin-bottom: 1rem;">ูุง ุชูุฌุฏ ุฏุฑูุณ ุญุชู ุงูุขู</h3>
                        <p>ุงุจุฏุฃ ุจุฅุถุงูุฉ ุฃูู ุฏุฑุณ ูู ูุชุจุฏุฃ ุฑุญูุฉ ุงูุชุฏุฑูุณ.</p>
                        <button onclick="toggleAddForm()" class="btn btn-primary" style="margin-top: 1rem;">ุฅุถุงูุฉ ุฏุฑุณ ุฌุฏูุฏ</button>
                    </div>
                `;
                return;
            }

            // ุชุฑุชูุจ ุงูุฏุฑูุณ ูู ุงูุฃุญุฏุซ ุฅูู ุงูุฃูุฏู
            const sortedLessons = lessons.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            myLessonsGrid.innerHTML = `
                <div class="lessons-dashboard-grid" style="display: grid; gap: 1.5rem;">
                    ${sortedLessons.map(lesson => `
                        <div class="lesson-dashboard-card" style="border-radius: 12px; padding: 1.5rem; display: flex; gap: 1.5rem; align-items: flex-start;">
                            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #2563EB, #059669); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: white; flex-shrink: 0;">
                                ${lesson.youtubeUrl ? '๐น' : '๐'}
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; color: #1F2937; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${lesson.title}</h3>
                                <p style="color: #6B7280; margin-bottom: 0.5rem; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${lesson.description}</p>
                                <div style="display: flex; gap: 1rem; font-size: 0.875rem; color: #6B7280; flex-wrap: wrap;">
                                    <span>๐ ${lesson.subject}</span>
                                    <span>๐๏ธ ${lesson.views || 0} ูุดุงูุฏุฉ</span>
                                    <span>๐ ${lesson.likes || 0} ุฅุนุฌุงุจ</span>
                                    <span>๐ ${formatArabicDate(lesson.createdAt)}</span>
                                </div>
                            </div>
                            <div class="lesson-actions-buttons" style="display: flex; flex-direction: column; gap: 0.5rem; flex-shrink: 0;">
                                <a href="lesson-view.html?id=${lesson.id}" class="btn btn-outline" style="padding: 6px 12px; font-size: 0.875rem; white-space: nowrap;">๐๏ธ ุนุฑุถ</a>
                                <button onclick="editLesson(${lesson.id})" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.875rem; white-space: nowrap;">โ๏ธ ุชุนุฏูู</button>
                                <button onclick="deleteLesson(${lesson.id})" class="btn btn-danger" style="padding: 6px 12px; font-size: 0.875rem; white-space: nowrap;">๐๏ธ ุญุฐู</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function toggleAddForm() {
            const form = document.getElementById('addLessonForm');
            const btn = document.getElementById('addLessonBtn');
            
            showingAddForm = !showingAddForm;
            
            if (showingAddForm) {
                form.classList.remove('hidden');
                btn.textContent = 'โ ุฅูุบุงุก';
                form.scrollIntoView({ behavior: 'smooth' });
            } else {
                form.classList.add('hidden');
                btn.textContent = 'โ ุฅุถุงูุฉ ุฏุฑุณ ุฌุฏูุฏ';
                document.getElementById('lessonForm').reset();
            }
        }

        // ุฅุถุงูุฉ ูุณุชูุน ููููุฐุฌ ุฅูุดุงุก ุงูุฏุฑุณ
        document.getElementById('lessonForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const lessonData = {
                title: formData.get('title'),
                description: formData.get('description'),
                subject: formData.get('subject'),
                youtubeUrl: formData.get('youtubeUrl') || null,
                pdfUrl: formData.get('pdfUrl') || null,
                duration: parseInt(formData.get('duration')) || 0
            };
            
            try {
                const response = await fetch('/api/lessons', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(lessonData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // ุนุฑุถ ุฑุณุงูุฉ ุชุฃููุฏ ูุงุญุฏุฉ ููุท
                    const successMsg = document.createElement('div');
                    successMsg.className = 'form-success';
                    successMsg.textContent = 'ุชู ุฅูุดุงุก ุงูุฏุฑุณ ุจูุฌุงุญ!';
                    successMsg.style.position = 'fixed';
                    successMsg.style.top = '20px';
                    successMsg.style.right = '20px';
                    successMsg.style.zIndex = '9999';
                    document.body.appendChild(successMsg);
                    
                    setTimeout(() => {
                        document.body.removeChild(successMsg);
                    }, 3000);
                    
                    event.target.reset();
                    toggleAddForm();
                    await loadMyLessons();
                } else {
                    alert(data.message || 'ุญุฏุซ ุฎุทุฃ ูู ุฅูุดุงุก ุงูุฏุฑุณ');
                }
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุฅูุดุงุก ุงูุฏุฑุณ:', error);
                alert('ุญุฏุซ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู');
            }
        });

        async function editLesson(lessonId) {
            // ุงูุจุญุซ ุนู ุงูุฏุฑุณ ูู ุงูุจูุงูุงุช ุงููุญููุฉ
            const response = await fetch('/api/my-lessons');
            const lessons = await response.json();
            const lesson = lessons.find(l => l.id === lessonId);
            
            if (!lesson) {
                alert('ุงูุฏุฑุณ ุบูุฑ ููุฌูุฏ');
                return;
            }
            
            // ููุก ุงููููุฐุฌ ุจุงูุจูุงูุงุช ุงูุญุงููุฉ
            document.getElementById('title').value = lesson.title;
            document.getElementById('subject').value = lesson.subject;
            document.getElementById('description').value = lesson.description;
            document.getElementById('youtubeUrl').value = lesson.youtubeUrl || '';
            document.getElementById('pdfUrl').value = lesson.pdfUrl || '';
            document.getElementById('duration').value = lesson.duration || '';
            
            // ุชุบููุฑ ุงููููุฐุฌ ุฅูู ูุถุน ุงูุชุนุฏูู
            const form = document.getElementById('lessonForm');
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = '๐พ ุชุญุฏูุซ ุงูุฏุฑุณ';
            submitBtn.onclick = () => updateLesson(lessonId);
            
            // ุฅุธูุงุฑ ุงููููุฐุฌ
            showingAddForm = false;
            toggleAddForm();
        }
        
        async function updateLesson(lessonId) {
            const form = document.getElementById('lessonForm');
            const formData = new FormData(form);
            
            const lessonData = {
                title: formData.get('title'),
                description: formData.get('description'),
                subject: formData.get('subject'),
                youtubeUrl: formData.get('youtubeUrl') || null,
                pdfUrl: formData.get('pdfUrl') || null,
                duration: parseInt(formData.get('duration')) || 0
            };
            
            try {
                const response = await fetch(`/api/lessons/${lessonId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(lessonData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('ุชู ุชุญุฏูุซ ุงูุฏุฑุณ ุจูุฌุงุญ!');
                    form.reset();
                    resetFormToAddMode();
                    toggleAddForm();
                    await loadMyLessons();
                } else {
                    alert(data.message || 'ุญุฏุซ ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุฏุฑุณ');
                }
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุฏุฑุณ:', error);
                alert('ุญุฏุซ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู');
            }
        }
        
        function resetFormToAddMode() {
            const form = document.getElementById('lessonForm');
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = '๐พ ุญูุธ ุงูุฏุฑุณ';
            submitBtn.onclick = null;
        }

        async function deleteLesson(lessonId) {
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุฏุฑุณุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/lessons/${lessonId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('ุชู ุญุฐู ุงูุฏุฑุณ ุจูุฌุงุญ');
                    await loadMyLessons();
                } else {
                    alert(data.message || 'ุญุฏุซ ุฎุทุฃ ูู ุญุฐู ุงูุฏุฑุณ');
                }
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุญุฐู ุงูุฏุฑุณ:', error);
                alert('ุญุฏุซ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู');
            }
        }
    </script>
</body>
</html>